<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDI-APS Brasil | Painel Executivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        /* Paleta Corporativa - Tons neutros e sofisticados */
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --surface: #f8fafc;
            --surface-alt: #f1f5f9;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
        }
        
        body { 
            background: var(--surface); 
            color: var(--text-primary);
        }
        
        /* Scrollbar elegante */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--surface-alt); }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Cards corporativos */
        .card-corporate {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        .card-corporate:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* Sidebar minimalista */
        .sidebar-corporate {
            background: var(--primary);
            width: 72px;
            transition: width 0.3s ease;
        }
        .sidebar-corporate:hover {
            width: 240px;
        }
        .sidebar-corporate .nav-label {
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        .sidebar-corporate:hover .nav-label {
            opacity: 1;
        }
        
        /* Header clean */
        .header-corporate {
            background: white;
            border-bottom: 1px solid var(--border);
            height: 64px;
        }
        
        /* Botões sofisticados */
        .btn-corporate {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-corporate:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-outline:hover {
            background: var(--surface-alt);
            border-color: var(--text-muted);
        }
        .btn-outline.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Inputs elegantes */
        .input-corporate {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .input-corporate:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
        }
        
        /* Select estilizado */
        .select-corporate {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 32px 8px 12px;
            font-size: 13px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            cursor: pointer;
        }
        .select-corporate:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Métricas KPI */
        .kpi-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent);
        }
        .kpi-card.success::before { background: #10b981; }
        .kpi-card.warning::before { background: #f59e0b; }
        .kpi-card.danger::before { background: #ef4444; }
        .kpi-card.info::before { background: #3b82f6; }
        
        /* Tabelas corporativas */
        .table-corporate {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-corporate th {
            background: var(--surface-alt);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }
        .table-corporate td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .table-corporate tbody tr:hover {
            background: var(--surface-alt);
        }
        
        /* Badge status */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-neutral { background: #f1f5f9; color: #475569; }
        
        /* Animações sutis */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease; }
        .animate-slideUp { animation: slideUp 0.4s ease; }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Landing page corporativa */
        .landing-corporate {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            min-height: 100vh;
        }
        
        /* Loader elegante */
        .loader-corporate {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tooltip */
        .tooltip-corporate {
            position: relative;
        }
        .tooltip-corporate::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        .tooltip-corporate:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 8px);
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: var(--surface-alt);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* Mapa */
        .leaflet-container {
            border-radius: 12px;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="./components.js"></script>
    <script type="text/babel" data-type="module">
const { useState, useEffect, useRef } = React;

if (typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', { display: false });
}

const fixMunicipioDisplay = (name) => {
    if (!name) return name;
    const fixes = { 'Acrelandia': 'Acrelândia', 'Brasileia': 'Brasiléia' };
    return fixes[name] || name;
};
const normalizeMunicipioForGeoJSON = (name) => name ? name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : '';

const LandingPage = ({ onSelectIndicator, user, onOpenAuth }) => {
    const indicators = [
        { key: 'gestantes', title: 'Gestantes e Puérperas', icon: 'fa-baby', desc: 'Acompanhamento pré-natal', states: ['acre', 'rn', 'am', 'mt'], municipios: ['msp'], stats: '11 Indicadores' },
        { key: 'has', title: 'Hipertensão Arterial', icon: 'fa-heart-pulse', desc: 'Monitoramento de hipertensos', states: ['rn'], stats: '4 Indicadores' },
        { key: 'dm', title: 'Diabetes Mellitus', icon: 'fa-droplet', desc: 'Controle de diabéticos', states: ['rn'], stats: '6 Indicadores' }
    ];
    const [sel, setSel] = useState(null);

    return (
        <div className="landing-corporate min-h-screen flex flex-col">
            <header className="px-8 py-6">
                <div className="max-w-7xl mx-auto flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center"><i className="fas fa-chart-line text-white"></i></div>
                        <div><h1 className="text-lg font-semibold text-white">GDI-APS</h1><p className="text-xs text-white/50 uppercase tracking-widest">Painel Executivo</p></div>
                    </div>
                    <button onClick={() => onOpenAuth()} className="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition-all text-white text-sm"><i className="fas fa-user"></i><span>{user ? user.name : 'Entrar'}</span></button>
                </div>
            </header>
            <section className="flex-1 flex items-center px-8 py-12">
                <div className="max-w-7xl mx-auto w-full">
                    <div className="max-w-2xl mb-16">
                        <p className="text-white/60 text-sm uppercase tracking-widest mb-4">Gestão de Desempenho</p>
                        <h2 className="text-5xl font-light text-white mb-6 leading-tight">Inteligência em <span className="font-semibold">Saúde Pública</span></h2>
                        <p className="text-white/70 text-lg">Plataforma analítica para monitoramento de indicadores da APS</p>
                    </div>
                    <div className="grid grid-cols-4 gap-6 mb-16">
                        <div className="bg-white/5 border border-white/10 rounded-xl p-6"><p className="text-4xl font-light text-white mb-2">3</p><p className="text-white/50 text-sm">Indicadores</p></div>
                        <div className="bg-white/5 border border-white/10 rounded-xl p-6"><p className="text-4xl font-light text-white mb-2">4</p><p className="text-white/50 text-sm">Estados</p></div>
                        <div className="bg-white/5 border border-white/10 rounded-xl p-6"><p className="text-4xl font-light text-white mb-2">+200</p><p className="text-white/50 text-sm">Municípios</p></div>
                        <div className="bg-white/5 border border-white/10 rounded-xl p-6"><p className="text-4xl font-light text-white mb-2">21</p><p className="text-white/50 text-sm">Boas Práticas</p></div>
                    </div>
                    <div className="grid grid-cols-3 gap-6">
                        {indicators.map((ind) => (
                            <div key={ind.key} onClick={() => setSel(ind)} className="bg-white/5 border border-white/10 hover:bg-white/10 rounded-xl p-8 cursor-pointer transition-all group">
                                <div className="w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><i className={`fas ${ind.icon} text-white text-xl`}></i></div>
                                <h3 className="text-xl font-medium text-white mb-2">{ind.title}</h3>
                                <p className="text-white/50 text-sm mb-4">{ind.desc}</p>
                                <div className="flex items-center justify-between"><span className="text-white/40 text-xs">{ind.stats}</span><i className="fas fa-arrow-right text-white/40 group-hover:translate-x-1 transition-transform"></i></div>
                            </div>
                        ))}
                    </div>
                </div>
            </section>
            {sel && (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setSel(null)}>
                    <div className="bg-white rounded-2xl p-8 max-w-md w-full animate-slideUp" onClick={e => e.stopPropagation()}>
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><i className={`fas ${sel.icon} text-slate-700 text-2xl`}></i></div>
                            <h3 className="text-2xl font-semibold text-slate-800">{sel.title}</h3>
                        </div>
                        <div className="mb-6">
                            <p className="text-xs uppercase tracking-wider text-slate-400 mb-3"><i className="fas fa-flag mr-2"></i>UFs</p>
                            <div className="space-y-2">
                                {sel.states.map(s => (<button key={s} onClick={() => onSelectIndicator(sel.key, s)} className="w-full p-4 bg-slate-50 hover:bg-slate-100 text-slate-700 rounded-xl font-medium transition-all flex items-center justify-between"><span><i className="fas fa-map-marker-alt text-slate-400 mr-3"></i>{STATE_CONFIG[s].name}</span><i className="fas fa-chevron-right text-slate-400"></i></button>))}
                            </div>
                        </div>
                        {sel.municipios && sel.municipios.length > 0 && (
                            <div>
                                <p className="text-xs uppercase tracking-wider text-slate-400 mb-3"><i className="fas fa-city mr-2"></i>Municípios</p>
                                <div className="space-y-2">
                                    {sel.municipios.map(m => (<button key={m} onClick={() => onSelectIndicator(sel.key, m)} className="w-full p-4 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-xl font-medium transition-all flex items-center justify-between"><span><i className="fas fa-building text-indigo-400 mr-3"></i>{STATE_CONFIG[m].name}</span><i className="fas fa-chevron-right text-indigo-400"></i></button>))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
            <footer className="px-8 py-6 border-t border-white/10"><div className="max-w-7xl mx-auto text-center"><p className="text-white/30 text-sm">© 2025 GDI-APS Brasil</p></div></footer>
        </div>
    );
};

const Dashboard = () => {
    const [indicatorType, setIndicatorType] = useState(null), [selectedState, setSelectedState] = useState(null);
    const [rawData, setRawData] = useState([]), [filteredData, setFilteredData] = useState([]);
    const [loading, setLoading] = useState(false), [error, setError] = useState(null), [activeView, setActiveView] = useState('home');
    const [filters, setFilters] = useState({ regiao: 'Todas', municipio: 'Todos', competencia: 'Todas', equipe: 'Todas' });
    const [geoJson, setGeoJson] = useState(null), [sidebarExpanded, setSidebarExpanded] = useState(false);
    const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('gdiaps_user')) || null);
    const [authModal, setAuthModal] = useState(false);
    const config = indicatorType ? INDICATOR_CONFIG[indicatorType] : null;
    const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#f97316'];

    useEffect(() => { user ? localStorage.setItem('gdiaps_user', JSON.stringify(user)) : localStorage.removeItem('gdiaps_user'); }, [user]);
    useEffect(() => { if (selectedState && STATE_CONFIG[selectedState] && STATE_CONFIG[selectedState].geojson) fetch(STATE_CONFIG[selectedState].geojson).then(r => r.json()).then(setGeoJson).catch(console.error); else setGeoJson(null); }, [selectedState]);
    useEffect(() => { if (indicatorType && selectedState) loadData(indicatorType, selectedState); }, [indicatorType, selectedState]);

    const loadData = (type, state) => {
        const cfg = INDICATOR_CONFIG[type]; if (!cfg || !cfg.csvFiles[state]) return;
        setLoading(true);
        const encoding = cfg.csvFiles[state].encoding || 'windows-1252';
        fetch(cfg.csvFiles[state].file).then(r => r.arrayBuffer()).then(buf => Papa.parse(new TextDecoder(encoding).decode(buf), { header: false, skipEmptyLines: true, delimiter: cfg.csvFiles[state].delimiter })).then(results => {
            const parseNum = v => { if (!v) return 0; let c = String(v).replace(/"/g, '').trim(); if (state === 'acre') c = c.replace(/\./g, '').replace(',', '.'); else { if (c.includes(',') && c.includes('.')) c = c.replace('.', '').replace(',', '.'); else if (c.includes(',')) c = c.replace(',', '.'); } return parseFloat(c) || 0; };
            const data = results.data.slice(1).filter(r => r[0] && r[0].trim()).map(r => {
                const base = { cnes: r[0], estabelecimento: r[1], tipo: r[2], ine: r[3], nomeEquipe: r[4], sigla: r[5], municipio: fixMunicipioDisplay(r[6]), regiao: r[7], competencia: normalizeMonth(r[8]) };
                if (type === 'gestantes') return { ...base, ind1: parseNum(r[10]), ind2: parseNum(r[11]), ind3: parseNum(r[12]), ind4: parseNum(r[13]), ind5: parseNum(r[14]), ind6: parseNum(r[15]), ind7: parseNum(r[16]), ind8: parseNum(r[17]), ind9: parseNum(r[18]), ind10: parseNum(r[19]), ind11: parseNum(r[20]), somatorio: parseNum(r[21]), totalPacientes: parseNum(r[22]) };
                if (type === 'has') return { ...base, ind1: parseNum(r[10]), ind2: parseNum(r[11]), ind3: parseNum(r[12]), ind4: parseNum(r[13]), somatorio: parseNum(r[14]), totalPacientes: parseNum(r[15]) };
                if (type === 'dm') return { ...base, ind1: parseNum(r[10]), ind2: parseNum(r[11]), ind3: parseNum(r[12]), ind4: parseNum(r[13]), ind5: parseNum(r[14]), ind6: parseNum(r[15]), somatorio: parseNum(r[16]), totalPacientes: parseNum(r[17]) };
                return base;
            });
            setRawData(data); setFilteredData(data); setFilters({ regiao: 'Todas', municipio: 'Todos', competencia: 'Todas', equipe: 'Todas' }); setLoading(false);
        }).catch(e => { setError(e.message); setLoading(false); });
    };

    useEffect(() => { let d = [...rawData]; if (filters.regiao !== 'Todas') d = d.filter(r => r.regiao === filters.regiao); if (filters.municipio !== 'Todos') d = d.filter(r => r.municipio === filters.municipio); if (filters.competencia !== 'Todas') d = d.filter(r => r.competencia === filters.competencia); if (filters.equipe !== 'Todas') d = d.filter(r => r.nomeEquipe === filters.equipe); setFilteredData(d); }, [filters, rawData]);

    const getUnique = (field, data) => { const src = data || rawData; return [...new Set(src.map(r => r[field]).filter(Boolean))].sort(); };
    const getRegioes = () => getUnique('regiao');
    const getMunicipios = () => getUnique('municipio');
    const getEquipes = () => getUnique('nomeEquipe');
    const calcMetrics = (data) => { const src = data || filteredData; const total = src.reduce((s, r) => s + (r.totalPacientes || 0), 0), somatorio = src.reduce((s, r) => s + r.somatorio, 0); return { total, somatorio, taxa: total > 0 ? somatorio / total : 0, equipes: new Set(src.map(r => r.ine)).size, municipios: new Set(src.map(r => r.municipio)).size }; };
    const calcIndicators = (data) => { const src = data || filteredData; const total = src.reduce((s, r) => s + (r.totalPacientes || 0), 0), count = config ? config.indicatorCount : 11; return Array.from({ length: count }, (_, i) => { const sum = src.reduce((s, r) => s + (r['ind' + (i + 1)] || 0), 0); return { idx: i + 1, value: sum, pct: total > 0 ? (sum / total) * 100 : 0, name: config && config.shortNames ? config.shortNames[i] : 'Ind ' + (i + 1) }; }); };
    const getTrend = (data) => { const src = data || filteredData; const months = getUnique('competencia', src); return MONTH_ORDER.filter(m => months.includes(m)).map(m => { const d = src.filter(r => r.competencia === m); if (!d.length) return null; const sm = d.reduce((s, r) => s + r.somatorio, 0), tg = d.reduce((s, r) => s + (r.totalPacientes || 0), 0); return { month: m, taxa: tg ? sm / tg : 0 }; }).filter(Boolean); };
    const getHeatmap = (data) => { const src = data || filteredData; return getMunicipios().map(m => { const d = src.filter(r => r.municipio === m); const sm = d.reduce((s, r) => s + r.somatorio, 0), tg = d.reduce((s, r) => s + (r.totalPacientes || 0), 0); return { municipio: m, taxa: tg ? sm / tg : 0 }; }).sort((a, b) => b.taxa - a.taxa); };
    const getComponentTrend = (data) => { const src = data || filteredData; const months = getUnique('competencia', src), count = config ? config.indicatorCount : 11; return MONTH_ORDER.filter(m => months.includes(m)).map(m => { const d = src.filter(r => r.competencia === m); if (!d.length) return null; const total = d.reduce((s, r) => s + (r.totalPacientes || 0), 0); const inds = {}; for (let i = 1; i <= count; i++) { const sum = d.reduce((s, r) => s + (r['ind' + i] || 0), 0); inds['ind' + i] = total > 0 ? (sum / total) * 100 : 0; } return { month: m, ...inds }; }).filter(Boolean); };
    const getCategoria = (taxa) => { if (taxa >= 75) return { label: 'Ótimo', color: '#1e3a5f' }; if (taxa >= 50) return { label: 'Bom', color: '#22c55e' }; if (taxa >= 25) return { label: 'Suficiente', color: '#eab308' }; return { label: 'Regular', color: '#ef4444' }; };
    const getCategoriaComponente = (pct) => getCategoria(pct);
    const getTaxaColor = (taxa) => getCategoria(taxa).color;

    if (!indicatorType) return (
        <>
            <LandingPage onSelectIndicator={(type, state) => { setIndicatorType(type); setSelectedState(state); }} user={user} onOpenAuth={() => setAuthModal(true)} />
            {authModal && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center" onClick={() => setAuthModal(false)}>
                    <div className="bg-white rounded-2xl p-8 max-w-md w-full" onClick={e => e.stopPropagation()}>
                        <h3 className="text-2xl font-semibold text-center mb-6">Entrar</h3>
                        <form onSubmit={e => { e.preventDefault(); setUser({ name: 'Usuário', email: 'user@email.com' }); setAuthModal(false); }}>
                            <input type="email" placeholder="E-mail" className="input-corporate w-full mb-4" required />
                            <input type="password" placeholder="Senha" className="input-corporate w-full mb-6" required />
                            <button type="submit" className="btn-corporate w-full">Entrar</button>
                        </form>
                    </div>
                </div>
            )}
        </>
    );

    const Sidebar = () => (
        <aside className="sidebar-corporate fixed left-0 top-0 h-full z-40 flex flex-col" onMouseEnter={() => setSidebarExpanded(true)} onMouseLeave={() => setSidebarExpanded(false)}>
            <div className="p-4 border-b border-white/10"><div className="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center"><i className="fas fa-chart-line text-white"></i></div></div>
            <nav className="flex-1 py-4">
                {[{id:'home',icon:'fa-th-large',label:'Visão Geral'},{id:'components',icon:'fa-layer-group',label:'Componentes'},{id:'indicators',icon:'fa-chart-bar',label:'Comparativo'},{id:'map',icon:'fa-map',label:'Mapa'},{id:'goals',icon:'fa-bullseye',label:'Metas'},{id:'evaluation',icon:'fa-clipboard-check',label:'Avaliação'}].map(item => (
                    <button key={item.id} onClick={() => setActiveView(item.id)} className={`w-full flex items-center gap-4 px-5 py-3 text-left transition-all ${activeView === item.id ? 'bg-white/10 text-white border-r-2 border-white' : 'text-white/60 hover:text-white hover:bg-white/5'}`}>
                        <i className={`fas ${item.icon} w-5 text-center`}></i>
                        <span className="nav-label text-sm font-medium">{item.label}</span>
                    </button>
                ))}
            </nav>
            <div className="p-4 border-t border-white/10">
                <button onClick={() => { setIndicatorType(null); setSelectedState(null); setRawData([]); setFilteredData([]); }} className="w-full flex items-center gap-4 px-1 py-2 text-white/60 hover:text-white">
                    <i className="fas fa-arrow-left w-5 text-center"></i>
                    <span className="nav-label text-sm">Voltar</span>
                </button>
            </div>
        </aside>
    );

    const Header = () => (
        <header className="header-corporate fixed top-0 left-[72px] right-0 z-30 px-6 flex items-center justify-between">
            <div><h1 className="text-lg font-semibold text-slate-800">{config ? config.title : ''}</h1><p className="text-xs text-slate-500">{STATE_CONFIG[selectedState] ? STATE_CONFIG[selectedState].name : ''}</p></div>
            <div className="flex items-center gap-4"><span className="text-sm text-slate-600"><i className="fas fa-database text-slate-400 mr-2"></i>{filteredData.length.toLocaleString()} registros</span><div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center"><i className="fas fa-user text-slate-500 text-sm"></i></div></div>
        </header>
    );

    const FilterBar = () => (
        <div className="card-corporate p-4 mb-6">
            <div className="flex items-center gap-4 flex-wrap">
                <i className="fas fa-filter text-slate-400"></i>
                <select className="select-corporate" value={filters.regiao} onChange={e => setFilters({ ...filters, regiao: e.target.value })}><option value="Todas">Todas Regiões</option>{getRegioes().map(r => <option key={r} value={r}>{r}</option>)}</select>
                <select className="select-corporate" value={filters.municipio} onChange={e => setFilters({ ...filters, municipio: e.target.value })}><option value="Todos">Todos Municípios</option>{getMunicipios().map(m => <option key={m} value={m}>{m}</option>)}</select>
                <select className="select-corporate" value={filters.competencia} onChange={e => setFilters({ ...filters, competencia: e.target.value })}><option value="Todas">Todas Competências</option>{MONTH_ORDER.filter(m => getUnique('competencia').includes(m)).map(c => <option key={c} value={c}>{c}</option>)}</select>
                <select className="select-corporate" value={filters.equipe} onChange={e => setFilters({ ...filters, equipe: e.target.value })}><option value="Todas">Todas Equipes</option>{getEquipes().map(eq => <option key={eq} value={eq}>{eq}</option>)}</select>
            </div>
        </div>
    );

    const KPICard = ({ title, value, icon, type }) => (
        <div className={`kpi-card ${type || 'info'}`}>
            <div className="flex items-start justify-between">
                <div><p className="text-xs uppercase tracking-wider text-slate-500 mb-1">{title}</p><p className="text-3xl font-semibold text-slate-800">{value}</p></div>
                <div className="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center"><i className={`fas ${icon} text-slate-500`}></i></div>
            </div>
        </div>
    );

    const SimpleLineChart = ({ data }) => {
        const chartRef = useRef(null), chartInstance = useRef(null);
        useEffect(() => {
            if (!chartRef.current || !data || !data.length) return;
            if (chartInstance.current) chartInstance.current.destroy();
            chartInstance.current = new Chart(chartRef.current, {
                type: 'line',
                data: { labels: data.map(d => d.month), datasets: [{ data: data.map(d => d.taxa), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4, pointRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } }
            });
            return () => { if (chartInstance.current) chartInstance.current.destroy(); };
        }, [data]);
        return <canvas ref={chartRef}></canvas>;
    };

    const SimpleBarChart = ({ data }) => {
        const chartRef = useRef(null), chartInstance = useRef(null);
        useEffect(() => {
            if (!chartRef.current || !data || !data.length) return;
            if (chartInstance.current) chartInstance.current.destroy();
            chartInstance.current = new Chart(chartRef.current, {
                type: 'bar',
                data: { labels: data.map(d => d.name), datasets: [{ data: data.map(d => d.pct), backgroundColor: data.map(d => getCategoriaComponente(d.pct).color), borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' } }, y: { grid: { display: false } } } }
            });
            return () => { if (chartInstance.current) chartInstance.current.destroy(); };
        }, [data]);
        return <canvas ref={chartRef}></canvas>;
    };

    const HomeView = () => {
        const m = calcMetrics(), ind = calcIndicators(), trend = getTrend(), cat = getCategoria(m.taxa), hm = getHeatmap(), top5 = hm.slice(0, 5), bottom5 = [...hm].sort((a, b) => a.taxa - b.taxa).slice(0, 5);
        return (
            <div className="animate-fadeIn">
                <FilterBar />
                <div className="grid grid-cols-5 gap-4 mb-6">
                    <KPICard title="Taxa Geral" value={m.taxa.toFixed(2)} icon="fa-chart-line" type={m.taxa >= 50 ? 'success' : 'warning'} />
                    <KPICard title="Pacientes" value={m.total.toLocaleString()} icon="fa-users" />
                    <KPICard title="Somatório" value={m.somatorio.toLocaleString()} icon="fa-calculator" />
                    <KPICard title="Equipes" value={m.equipes} icon="fa-user-md" />
                    <KPICard title="Municípios" value={m.municipios} icon="fa-map-marker-alt" />
                </div>
                <div className="grid grid-cols-3 gap-6 mb-6">
                    <div className="col-span-2 card-corporate p-6"><h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-chart-line text-slate-400 mr-2"></i>Evolução Mensal</h3><div className="h-64"><SimpleLineChart data={trend} /></div></div>
                    <div className="card-corporate p-6"><h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-tasks text-slate-400 mr-2"></i>Indicadores</h3><div className="h-64"><SimpleBarChart data={ind} /></div></div>
                </div>
                <div className="grid grid-cols-2 gap-6">
                    <div className="card-corporate p-6"><h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-trophy text-green-500 mr-2"></i>Top 5</h3><div className="space-y-2">{top5.map((m, i) => (<div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><span className="text-sm font-medium">{i + 1}. {m.municipio}</span><span className="text-sm font-semibold" style={{ color: getCategoria(m.taxa).color }}>{m.taxa.toFixed(2)}</span></div>))}</div></div>
                    <div className="card-corporate p-6"><h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-exclamation-triangle text-amber-500 mr-2"></i>Atenção</h3><div className="space-y-2">{bottom5.map((m, i) => (<div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><span className="text-sm font-medium">{i + 1}. {m.municipio}</span><span className="text-sm font-semibold" style={{ color: getCategoria(m.taxa).color }}>{m.taxa.toFixed(2)}</span></div>))}</div></div>
                </div>
            </div>
        );
    };

    const ComponentsView = () => {
        const ind = calcIndicators(), compTrend = getComponentTrend(), [selectedInd, setSelectedInd] = useState(1), [chartMode, setChartMode] = useState('mensal');
        const getChartData = () => {
            if (chartMode === 'mensal') return compTrend;
            if (chartMode === 'acumulado') { let acc = {}; return compTrend.map((d, idx) => { const result = { month: d.month }; const count = config ? config.indicatorCount : 11; for (let i = 1; i <= count; i++) { acc['ind' + i] = (acc['ind' + i] || 0) + d['ind' + i]; result['ind' + i] = acc['ind' + i] / (idx + 1); } return result; }); }
            const quads = [], count = config ? config.indicatorCount : 11; for (let i = 0; i < compTrend.length; i += 4) { const chunk = compTrend.slice(i, i + 4); if (!chunk.length) continue; const result = { month: 'Q' + (Math.floor(i / 4) + 1) }; for (let j = 1; j <= count; j++) result['ind' + j] = chunk.reduce((s, d) => s + d['ind' + j], 0) / chunk.length; quads.push(result); } return quads;
        };
        const chartData = getChartData();
        const MultiLineChart = ({ data, selInd }) => {
            const chartRef = useRef(null), chartInstance = useRef(null);
            useEffect(() => {
                if (!chartRef.current || !data || !data.length) return;
                if (chartInstance.current) chartInstance.current.destroy();
                const count = config ? config.indicatorCount : 11;
                const datasets = Array.from({ length: count }, (_, i) => ({ label: 'Ind ' + (i + 1), data: data.map(d => d['ind' + (i + 1)]), borderColor: COLORS[i % COLORS.length], backgroundColor: 'transparent', borderWidth: selInd === i + 1 ? 3 : 1, pointRadius: selInd === i + 1 ? 4 : 0, tension: 0.4, hidden: selInd !== i + 1 }));
                chartInstance.current = new Chart(chartRef.current, { type: 'line', data: { labels: data.map(d => d.month), datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } } });
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data, selInd]);
            return <canvas ref={chartRef}></canvas>;
        };
        return (
            <div className="animate-fadeIn">
                <FilterBar />
                <div className="grid grid-cols-4 gap-4 mb-6">
                    {ind.map((i, idx) => { const cat = getCategoriaComponente(i.pct); return (
                        <div key={idx} onClick={() => setSelectedInd(i.idx)} className={`card-corporate p-4 cursor-pointer ${selectedInd === i.idx ? 'ring-2 ring-blue-500' : ''}`}>
                            <div className="flex items-center justify-between mb-2"><span className="text-xs font-medium text-slate-500">Ind. {i.idx}</span><span className="text-xs px-2 py-1 rounded-full" style={{ background: cat.color + '20', color: cat.color }}>{cat.label}</span></div>
                            <p className="text-2xl font-semibold text-slate-800">{i.pct.toFixed(1)}%</p>
                            <div className="progress-bar mt-2"><div className="progress-bar-fill" style={{ width: i.pct + '%', background: cat.color }}></div></div>
                        </div>
                    ); })}
                </div>
                <div className="card-corporate p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-sm font-semibold text-slate-700"><i className="fas fa-chart-area text-slate-400 mr-2"></i>Evolução</h3>
                        <div className="flex gap-2">
                            <button onClick={() => setChartMode('mensal')} className={`btn-outline text-xs ${chartMode === 'mensal' ? 'active' : ''}`}>Mensal</button>
                            <button onClick={() => setChartMode('acumulado')} className={`btn-outline text-xs ${chartMode === 'acumulado' ? 'active' : ''}`}>Acumulado</button>
                            <button onClick={() => setChartMode('quadrimestral')} className={`btn-outline text-xs ${chartMode === 'quadrimestral' ? 'active' : ''}`}>Quadrimestral</button>
                        </div>
                    </div>
                    <div className="h-80"><MultiLineChart data={chartData} selInd={selectedInd} /></div>
                </div>
            </div>
        );
    };

    const IndicatorsView = () => {
        const hm = getHeatmap(), regioes = getRegioes();
        const regiaoData = regioes.map(r => { const d = filteredData.filter(x => x.regiao === r); const sm = d.reduce((s, x) => s + x.somatorio, 0), tg = d.reduce((s, x) => s + (x.totalPacientes || 0), 0); return { regiao: r, taxa: tg ? sm / tg : 0, municipios: new Set(d.map(x => x.municipio)).size, equipes: new Set(d.map(x => x.ine)).size }; }).sort((a, b) => b.taxa - a.taxa);
        return (
            <div className="animate-fadeIn">
                <FilterBar />
                <div className="card-corporate p-6 mb-6">
                    <h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-map-marked text-slate-400 mr-2"></i>Por Região</h3>
                    <table className="table-corporate"><thead><tr><th>Região</th><th>Taxa</th><th>Status</th><th>Municípios</th><th>Equipes</th></tr></thead>
                    <tbody>{regiaoData.map((r, i) => { const cat = getCategoria(r.taxa); return (<tr key={i}><td className="font-medium">{r.regiao}</td><td className="font-semibold" style={{ color: cat.color }}>{r.taxa.toFixed(2)}</td><td><span className="text-xs px-2 py-1 rounded-full" style={{ background: cat.color + '20', color: cat.color }}>{cat.label}</span></td><td>{r.municipios}</td><td>{r.equipes}</td></tr>); })}</tbody></table>
                </div>
                <div className="card-corporate p-6">
                    <h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-city text-slate-400 mr-2"></i>Ranking Municípios</h3>
                    <div className="max-h-96 overflow-y-auto"><table className="table-corporate"><thead className="sticky top-0"><tr><th>#</th><th>Município</th><th>Taxa</th><th>Status</th></tr></thead>
                    <tbody>{hm.map((m, i) => { const cat = getCategoria(m.taxa); return (<tr key={i}><td className="text-slate-400">{i + 1}</td><td className="font-medium">{m.municipio}</td><td className="font-semibold" style={{ color: cat.color }}>{m.taxa.toFixed(2)}</td><td><span className="text-xs px-2 py-1 rounded-full" style={{ background: cat.color + '20', color: cat.color }}>{cat.label}</span></td></tr>); })}</tbody></table></div>
                </div>
            </div>
        );
    };

    const MapView = () => {
        const mapRef = useRef(null), mapInstance = useRef(null);
        const hm = getHeatmap(), isMunicipio = STATE_CONFIG[selectedState] ? STATE_CONFIG[selectedState].isMunicipio : false, municipioCode = STATE_CONFIG[selectedState] ? STATE_CONFIG[selectedState].municipioCode : null;
        const clusters = { otimo: hm.filter(m => getCategoria(m.taxa).label === 'Ótimo').length, bom: hm.filter(m => getCategoria(m.taxa).label === 'Bom').length, suficiente: hm.filter(m => getCategoria(m.taxa).label === 'Suficiente').length, regular: hm.filter(m => getCategoria(m.taxa).label === 'Regular').length };
        useEffect(() => {
            if (!mapRef.current || !geoJson) return;
            if (mapInstance.current) { mapInstance.current.remove(); mapInstance.current = null; }
            const coords = selectedState === 'acre' ? [-9, -70] : selectedState === 'am' ? [-4, -65] : selectedState === 'mt' ? [-13, -56] : selectedState === 'msp' ? [-23.55, -46.63] : [-5.8, -36.5];
            const zoom = selectedState === 'am' ? 5 : selectedState === 'mt' ? 5 : selectedState === 'msp' ? 10 : 7;
            const map = L.map(mapRef.current).setView(coords, zoom);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.geoJSON(geoJson, { filter: f => isMunicipio ? f.properties.id === municipioCode : true, style: f => { const d = hm.find(m => normalizeMunicipioForGeoJSON(m.municipio) === normalizeMunicipioForGeoJSON(f.properties.name)); return { fillColor: d ? getTaxaColor(d.taxa) : '#e2e8f0', weight: 1, color: '#fff', fillOpacity: 0.7 }; }, onEachFeature: (f, l) => { const d = hm.find(m => normalizeMunicipioForGeoJSON(m.municipio) === normalizeMunicipioForGeoJSON(f.properties.name)); l.bindPopup('<b>' + f.properties.name + '</b><br>Taxa: ' + (d ? d.taxa.toFixed(2) : 'N/A')); } }).addTo(map);
            mapInstance.current = map;
            return () => { if (mapInstance.current) { mapInstance.current.remove(); mapInstance.current = null; } };
        }, [geoJson, filteredData, isMunicipio, municipioCode]);
        return (
            <div className="animate-fadeIn">
                <FilterBar />
                <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="card-corporate p-4 flex items-center gap-4"><div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: '#1e3a5f' }}><i className="fas fa-trophy text-white"></i></div><div><p className="text-2xl font-semibold">{clusters.otimo}</p><p className="text-xs text-slate-500">Ótimo</p></div></div>
                    <div className="card-corporate p-4 flex items-center gap-4"><div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: '#22c55e' }}><i className="fas fa-thumbs-up text-white"></i></div><div><p className="text-2xl font-semibold">{clusters.bom}</p><p className="text-xs text-slate-500">Bom</p></div></div>
                    <div className="card-corporate p-4 flex items-center gap-4"><div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: '#eab308' }}><i className="fas fa-check text-white"></i></div><div><p className="text-2xl font-semibold">{clusters.suficiente}</p><p className="text-xs text-slate-500">Suficiente</p></div></div>
                    <div className="card-corporate p-4 flex items-center gap-4"><div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: '#ef4444' }}><i className="fas fa-exclamation text-white"></i></div><div><p className="text-2xl font-semibold">{clusters.regular}</p><p className="text-xs text-slate-500">Regular</p></div></div>
                </div>
                <div className="card-corporate p-6">
                    <h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-map text-slate-400 mr-2"></i>Mapa</h3>
                    <div ref={mapRef} className="h-96 rounded-xl"></div>
                    <div className="flex items-center justify-center gap-6 mt-4">
                        <div className="flex items-center gap-2"><div className="w-4 h-4 rounded" style={{ background: '#1e3a5f' }}></div><span className="text-xs text-slate-600">Ótimo</span></div>
                        <div className="flex items-center gap-2"><div className="w-4 h-4 rounded" style={{ background: '#22c55e' }}></div><span className="text-xs text-slate-600">Bom</span></div>
                        <div className="flex items-center gap-2"><div className="w-4 h-4 rounded" style={{ background: '#eab308' }}></div><span className="text-xs text-slate-600">Suficiente</span></div>
                        <div className="flex items-center gap-2"><div className="w-4 h-4 rounded" style={{ background: '#ef4444' }}></div><span className="text-xs text-slate-600">Regular</span></div>
                    </div>
                </div>
            </div>
        );
    };

    const GoalsView = () => {
        const m = calcMetrics();
        return (
            <div className="animate-fadeIn">
                <FilterBar />
                <div className="card-corporate p-6">
                    <h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-bullseye text-slate-400 mr-2"></i>Meta Geral</h3>
                    <div className="flex items-center gap-6">
                        <div className="flex-1"><div className="flex justify-between mb-2"><span className="text-sm text-slate-600">Progresso</span><span className="text-sm font-semibold">{m.taxa.toFixed(2)} / 75</span></div><div className="progress-bar h-3"><div className="progress-bar-fill bg-blue-500" style={{ width: Math.min((m.taxa / 75) * 100, 100) + '%' }}></div></div></div>
                    </div>
                </div>
            </div>
        );
    };

    const EvaluationView = () => {
        const m = calcMetrics(), ind = calcIndicators(), cat = getCategoria(m.taxa);
        return (
            <div className="animate-fadeIn">
                <FilterBar />
                <div className="card-corporate p-6 mb-6">
                    <div className="flex items-center gap-6">
                        <div className="w-24 h-24 rounded-2xl flex items-center justify-center" style={{ background: cat.color }}><span className="text-4xl font-bold text-white">{m.taxa.toFixed(0)}</span></div>
                        <div><h3 className="text-2xl font-semibold text-slate-800">{cat.label}</h3><p className="text-slate-500">Classificação geral</p></div>
                    </div>
                </div>
                <div className="card-corporate p-6">
                    <h3 className="text-sm font-semibold text-slate-700 mb-4"><i className="fas fa-tasks text-slate-400 mr-2"></i>Por Indicador</h3>
                    <div className="space-y-4">{ind.map((i, idx) => { const c = getCategoriaComponente(i.pct); return (<div key={idx} className="flex items-center gap-4"><span className="w-20 text-sm text-slate-600">Ind. {i.idx}</span><div className="flex-1 progress-bar h-2"><div className="progress-bar-fill" style={{ width: i.pct + '%', background: c.color }}></div></div><span className="w-16 text-right text-sm font-semibold" style={{ color: c.color }}>{i.pct.toFixed(1)}%</span></div>); })}</div>
                </div>
            </div>
        );
    };

    if (loading) return (<div className="min-h-screen flex items-center justify-center"><div className="loader-corporate"></div></div>);

    return (
        <div className="min-h-screen bg-slate-50">
            <Sidebar />
            <Header />
            <main className="ml-[72px] pt-[64px] p-6">
                {activeView === 'home' && <HomeView />}
                {activeView === 'components' && <ComponentsView />}
                {activeView === 'indicators' && <IndicatorsView />}
                {activeView === 'map' && <MapView />}
                {activeView === 'goals' && <GoalsView />}
                {activeView === 'evaluation' && <EvaluationView />}
            </main>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
    </script>
</body>
</html>
